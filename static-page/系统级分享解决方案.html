<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿçº§åˆ†äº«è§£å†³æ–¹æ¡ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }
    </style>
</head>

<body>
    <h1>ç³»ç»Ÿçº§åˆ†äº«è§£å†³æ–¹æ¡ˆ</h1>

    <button class="btn" onclick="tryAllShareMethods()">ğŸš€ æ™ºèƒ½åˆ†äº«ï¼ˆæ¨èï¼‰</button>
    <button class="btn" onclick="testWebShare()">ğŸ“± æµ‹è¯•Web Share API</button>
    <button class="btn" onclick="useNativeBridge()">ğŸ”— å°è¯•Native Bridge</button>
    <button class="btn" onclick="useURLScheme()">ğŸ”§ ä½¿ç”¨URL Scheme</button>

    <div id="status"></div>

    <script>
        class AdvancedShareUtils {
            constructor() {
                this.browserInfo = this.detectBrowser();
            }

            // æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ
            detectBrowser() {
                const ua = navigator.userAgent;
                return {
                    isWechat: /MicroMessenger/i.test(ua),
                    isQQ: /QQ/i.test(ua),
                    isQuark: /Quark/i.test(ua),
                    isUC: /UCBrowser/i.test(ua),
                    isWeibo: /Weibo/i.test(ua),
                    isIOS: /iPad|iPhone|iPod/.test(ua),
                    isAndroid: /Android/.test(ua),
                    isChrome: /Chrome\/[.0-9]* Mobile/.test(ua),
                    isSafari: /Safari/.test(ua) && !/Chrome/.test(ua)
                };
            }

            // æ–¹æ³•1: å¢å¼ºç‰ˆWeb Share APIæ£€æµ‹
            async testWebShare() {
                this.showStatus('æµ‹è¯•Web Share API...', 'info');

                if (!navigator.share) {
                    this.showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒWeb Share API', 'error');
                    return false;
                }

                // æµ‹è¯•æ˜¯å¦èƒ½åˆ†äº«åŸºç¡€å†…å®¹
                const testData = {
                    title: 'æµ‹è¯•åˆ†äº«',
                    text: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åˆ†äº«å†…å®¹',
                    url: window.location.href
                };

                try {
                    // å…ˆæ£€æŸ¥æ˜¯å¦æ”¯æŒåˆ†äº«
                    if (navigator.canShare && !navigator.canShare(testData)) {
                        this.showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«æ­¤ç±»å†…å®¹', 'error');
                        return false;
                    }

                    await navigator.share(testData);
                    this.showStatus('âœ… Web Share API åˆ†äº«æˆåŠŸï¼', 'success');
                    return true;
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.showStatus('âš ï¸ ç”¨æˆ·å–æ¶ˆäº†åˆ†äº«', 'info');
                    } else {
                        this.showStatus(`âŒ Web Share API é”™è¯¯: ${error.message}`, 'error');
                    }
                    return false;
                }
            }

            // æ–¹æ³•2: Native Bridge æ–¹æ¡ˆï¼ˆä¸Appäº¤äº’ï¼‰
            useNativeBridge() {
                this.showStatus('å°è¯•é€šè¿‡Native Bridgeè°ƒç”¨ç³»ç»Ÿåˆ†äº«...', 'info');

                const shareData = {
                    title: 'Nativeåˆ†äº«æµ‹è¯•',
                    content: 'è¿™æ˜¯é€šè¿‡Native Bridgeåˆ†äº«çš„å†…å®¹',
                    url: window.location.href,
                    image: '' // å¯ä»¥æ·»åŠ ç¼©ç•¥å›¾URL
                };

                // Android - é€šè¿‡JavaScript Interface
                if (this.browserInfo.isAndroid && window.AndroidBridge) {
                    try {
                        window.AndroidBridge.shareToSystem(JSON.stringify(shareData));
                        this.showStatus('âœ… å·²è°ƒç”¨Android Nativeåˆ†äº«', 'success');
                        return true;
                    } catch (e) {
                        this.showStatus('âŒ Android Native Bridgeè°ƒç”¨å¤±è´¥', 'error');
                    }
                }

                // iOS - é€šè¿‡WebKitæ¶ˆæ¯å¤„ç†
                if (this.browserInfo.isIOS && window.webkit) {
                    try {
                        window.webkit.messageHandlers.shareHandler.postMessage(shareData);
                        this.showStatus('âœ… å·²è°ƒç”¨iOS Nativeåˆ†äº«', 'success');
                        return true;
                    } catch (e) {
                        this.showStatus('âŒ iOS Native Bridgeè°ƒç”¨å¤±è´¥', 'error');
                    }
                }

                // é€šç”¨æ–¹æ¡ˆ - å°è¯•è°ƒç”¨å¯èƒ½çš„Bridge
                this.tryUniversalBridge(shareData);
                return false;
            }

            // æ–¹æ³•3: å°è¯•é€šç”¨Bridgeæ–¹æ¡ˆ
            tryUniversalBridge(shareData) {
                const bridges = [
                    'jsBridge',
                    'webkit',
                    'AndroidBridge',
                    'YixinJSBridge',
                    '_ks_jsbridge',
                    'QuarkJSBridge'
                ];

                for (const bridgeName of bridges) {
                    if (window[bridgeName]) {
                        this.showStatus(`ğŸ” æ£€æµ‹åˆ° ${bridgeName}ï¼Œå°è¯•è°ƒç”¨...`, 'info');

                        // è¿™é‡Œéœ€è¦æ ¹æ®å…·ä½“çš„Bridgeæ–‡æ¡£æ¥è°ƒç”¨
                        // ä¸åŒæµè§ˆå™¨çš„Bridge APIä¸åŒ
                        setTimeout(() => {
                            this.showStatus(`âš ï¸ éœ€è¦æ ¹æ® ${bridgeName} çš„æ–‡æ¡£å®ç°å…·ä½“åˆ†äº«é€»è¾‘`, 'info');
                        }, 1000);
                        return;
                    }
                }

                this.showStatus('âŒ æœªæ£€æµ‹åˆ°å¯ç”¨çš„Native Bridge', 'error');
                setTimeout(() => {
                    this.showStatus('ğŸ’¡ å»ºè®®ï¼šä½¿ç”¨URL Schemeæ–¹æ¡ˆæˆ–è‡ªå®šä¹‰åˆ†äº«é¢æ¿', 'info');
                }, 1500);
            }

            // æ–¹æ³•4: URL Scheme æ–¹æ¡ˆ
            useURLScheme() {
                this.showStatus('å°è¯•é€šè¿‡URL Schemeè°ƒç”¨ç³»ç»Ÿåˆ†äº«...', 'info');

                const text = encodeURIComponent('åˆ†äº«å†…å®¹ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åˆ†äº«');
                const url = encodeURIComponent(window.location.href);

                let schemeUrl = '';

                if (this.browserInfo.isIOS) {
                    // iOS ç³»ç»Ÿåˆ†äº«Scheme
                    schemeUrl = `shared://com.apple.social.share?text=${text}&url=${url}`;
                } else if (this.browserInfo.isAndroid) {
                    // Android Intent Scheme
                    schemeUrl = `intent://share?text=${text}&url=${url}#Intent;package=com.android.chrome;scheme=https;end`;
                }

                if (schemeUrl) {
                    this.showStatus('ğŸ”— å°è¯•æ‰“å¼€ç³»ç»Ÿåˆ†äº«...', 'info');
                    window.location.href = schemeUrl;

                    // æ£€æµ‹æ˜¯å¦æˆåŠŸæ‰“å¼€
                    setTimeout(() => {
                        if (!document.hidden) {
                            this.showStatus('âŒ URL Schemeè°ƒç”¨å¤±è´¥ï¼Œå¯èƒ½ä¸è¢«æ”¯æŒ', 'error');
                            this.fallbackToCustomShare();
                        }
                    }, 1000);
                } else {
                    this.showStatus('âŒ æ— æ³•ç”Ÿæˆé€‚åˆå½“å‰å¹³å°çš„URL Scheme', 'error');
                    this.fallbackToCustomShare();
                }
            }

            // æ–¹æ³•5: é™çº§åˆ°è‡ªå®šä¹‰åˆ†äº«é¢æ¿
            fallbackToCustomShare() {
                this.showStatus('ğŸ”„ é™çº§åˆ°è‡ªå®šä¹‰åˆ†äº«é¢æ¿...', 'info');

                // åˆ›å»ºè‡ªå®šä¹‰åˆ†äº«ç•Œé¢
                const sharePanel = this.createCustomSharePanel();
                document.body.appendChild(sharePanel);
            }

            createCustomSharePanel() {
                const panel = document.createElement('div');
                panel.innerHTML = `
                    <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
                        <div style="position:absolute; bottom:0; left:0; width:100%; background:white; border-radius:20px 20px 0 0; padding:20px;">
                            <h3>åˆ†äº«åˆ°</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                                <button onclick="shareToWechat()" style="padding:10px; border:none; background:#f0f0f0; border-radius:10px;">å¾®ä¿¡</button>
                                <button onclick="shareToQQ()" style="padding:10px; border:none; background:#f0f0f0; border-radius:10px;">QQ</button>
                                <button onclick="shareToWeibo()" style="padding:10px; border:none; background:#f0f0f0; border-radius:10px;">å¾®åš</button>
                                <button onclick="copyLink()" style="padding:10px; border:none; background:#f0f0f0; border-radius:10px;">å¤åˆ¶é“¾æ¥</button>
                            </div>
                            <button onclick="closeSharePanel()" style="width:100%; padding:15px; background:#ff3b30; color:white; border:none; border-radius:10px;">å…³é—­</button>
                        </div>
                    </div>
                `;
                return panel;
            }

            // æ–¹æ³•6: æ™ºèƒ½åˆ†äº« - å°è¯•æ‰€æœ‰æ–¹æ³•
            async tryAllShareMethods() {
                this.showStatus('ğŸš€ å¼€å§‹æ™ºèƒ½åˆ†äº«ï¼Œå°è¯•æ‰€æœ‰å¯ç”¨æ–¹æ³•...', 'info');

                // 1. é¦–å…ˆå°è¯•Web Share API
                if (await this.testWebShare()) {
                    return;
                }

                // 2. å°è¯•Native Bridge
                setTimeout(() => {
                    if (!this.useNativeBridge()) {
                        // 3. æœ€åé™çº§åˆ°è‡ªå®šä¹‰åˆ†äº«
                        setTimeout(() => {
                            this.fallbackToCustomShare();
                        }, 1500);
                    }
                }, 1000);
            }

            showStatus(message, type) {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }
        }

        // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
        const shareUtils = new AdvancedShareUtils();

        function tryAllShareMethods() {
            shareUtils.tryAllShareMethods();
        }

        function testWebShare() {
            shareUtils.testWebShare();
        }

        function useNativeBridge() {
            shareUtils.useNativeBridge();
        }

        function useURLScheme() {
            shareUtils.useURLScheme();
        }

        function closeSharePanel() {
            const panels = document.querySelectorAll('[style*="position:fixed"]');
            panels.forEach(panel => panel.remove());
        }

        function shareToWechat() {
            shareUtils.showStatus('ğŸ’¬ åˆ†äº«åˆ°å¾®ä¿¡ï¼ˆéœ€è¦æ¥å…¥å¾®ä¿¡JS-SDKï¼‰', 'info');
            closeSharePanel();
        }

        function shareToQQ() {
            shareUtils.showStatus('ğŸ§ åˆ†äº«åˆ°QQï¼ˆéœ€è¦æ¥å…¥QQ SDKï¼‰', 'info');
            closeSharePanel();
        }

        function shareToWeibo() {
            const url = `http://service.weibo.com/share/share.php?title=${encodeURIComponent('åˆ†äº«æ ‡é¢˜')}&url=${encodeURIComponent(window.location.href)}`;
            window.open(url, '_blank');
            closeSharePanel();
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                shareUtils.showStatus('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                shareUtils.showStatus('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
            closeSharePanel();
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹ç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', function () {
            const info = shareUtils.browserInfo;
            let envInfo = `æ£€æµ‹åˆ°: `;

            if (info.isQuark) envInfo += 'å¤¸å…‹æµè§ˆå™¨ ';
            if (info.isWechat) envInfo += 'å¾®ä¿¡ ';
            if (info.isQQ) envInfo += 'QQæµè§ˆå™¨ ';
            if (info.isUC) envInfo += 'UCæµè§ˆå™¨ ';
            if (info.isIOS) envInfo += 'iOS ';
            if (info.isAndroid) envInfo += 'Android ';

            shareUtils.showStatus(envInfo, 'info');
        });
    </script>
</body>

</html>
