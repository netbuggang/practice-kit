<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Aliyun Mqtt Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js" type="text/javascript"></script>
    <script type="text/javascript">
        // {"code":"0","data":{"password":"Nxg8PBS0cmVVJbctQc0wWrH55OI=","clientId":"GID_ENZO@@@LINGREN","groupId":"GID_ENZO","host":"post-cn-qzm4iorvf04.mqtt.aliyuncs.com","topic":"TP_WECHAT","username":"Signature|LTAI5tBo3BrsFuBhapbD8dGt|post-cn-qzm4iorvf04"},"errorMsg":"","msg":"成功","success":true,"traceId":"0ba6f9ea176300495989454761142"}

        //    {"code":"0","data":{"password":"tEsWurwwUBGtXA6nnp+Xq3L26s0=","clientId":"GID_ENZO@@@MOCKED_USER_ID","groupId":"GID_ENZO","host":"post-cn-qzm4iorvf04.mqtt.aliyuncs.com","topic":"TP_WECHAT","username":"Signature|LTAI5tBo3BrsFuBhapbD8dGt|post-cn-qzm4iorvf04"},"errorMsg":"","msg":"成功","success":true,"traceId":"0ba6f9ea176300482489052021142"}
        instanceId = '';//实例 ID，购买后从控制台获取
        host = 'post-cn-qzm4iorvf04.mqtt.aliyuncs.com';// 设置当前用户的接入点域名，接入点获取方法请参考接入准备章节文档，先在控制台创建实例
        port = 80;//WebSocket 协议服务端口，如果是走 HTTPS，设置443端口
        topic = 'TP_WECHAT';//需要操作的 Topic,第一级父级 topic 需要在控制台申请
        useTLS = false;//是否走加密 HTTPS，如果走 HTTPS，设置为 true
        accessKey = 'XXXXX';
        //账号的的 SecretKey，在阿里云控制台查看
        secretKey = 'XXXXX';
        cleansession = true;
        groupId = 'GID_ENZO';//MQTT GroupID,创建实例后从 MQTT 控制台创建
        clientId = 'GID_ENZO@@@LINGREN';//GroupId@@@DeviceId，由控制台创建的 Group ID 和自己指定的 Device ID 组合构成
        var mqtt;
        var reconnectTimeout = 2000;
        var username = "Signature|LTAI5tBo3BrsFuBhapbD8dGt|post-cn-qzm4iorvf04";//username和 Password 签名模式下的设置方法，参考文档 https://help.aliyun.com/document_detail/48271.html?spm=a2c4g.11186623.6.553.217831c3BSFry7
        var password = "Nxg8PBS0cmVVJbctQc0wWrH55OI=";

        function MQTTconnect() {
            mqtt = new Paho.MQTT.Client(
                host,//MQTT 域名
                port,//WebSocket 端口，如果使用 HTTPS 加密则配置为443,否则配置80
                clientId,//客户端 ClientId
            );
            var options = {
                timeout: 3,
                onSuccess: onConnect,
                mqttVersion: 4,
                cleanSession: cleansession,
                onFailure: function (message) {
                    console.log(1111, message)
                    setTimeout(MQTTconnect, reconnectTimeout);
                }
            };
            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;
            mqtt.onMessageDelivered = onMessageDelivered;
            mqtt.onConnected = onConnected;
            if (username != null) {
                options.userName = username;
                options.password = password;
                options.useSSL = useTLS;//如果使用 HTTPS 加密则配置为 true
            }
            mqtt.connect(options);
        }

        function onConnect() {
            console.log("111连接成功～")
            // Connection succeeded; subscribe to our topic
            mqtt.subscribe(topic, { qos: 0 });
        }

        function onConnectionLost(response) {
            setTimeout(MQTTconnect, reconnectTimeout);
        };

        function onMessageArrived(message) {
            var topic = message.destinationName;
            var payload = message.payloadString;
            console.log("222收到消息了: " + topic + "   " + payload);
            displayMessage(`[${new Date().toLocaleTimeString()}] ${payload}`);
        };

        function onMessageDelivered(e) {
            // console.log("333已经收到消息了～", e)
        };

        function onConnected(e) {
            console.log(888, e)
        };

        MQTTconnect();

        function sendMsg() {
            const inputValue = document.getElementById('userInput').value;
            message = new Paho.MQTT.Message(inputValue);
            message.destinationName = topic;// set topic
            mqtt.send(message);
        }

        function displayMessage(msg) {
            const messageArea = document.getElementById('messageArea');
            const p = document.createElement('p');
            p.textContent = msg;
            messageArea.appendChild(p);
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    </script>
</head>

<body>
    <input type="text" id="userInput" placeholder="请输入内容">
    <button onclick="sendMsg()">发送消息</button>
    <div id="messageArea"
        style="margin-top:20px; padding:10px; border:1px solid #ccc; height:500px;overflow-y: scroll;"></div>
</body>

</html>
